<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sign Up | Yantrakart USERS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
:root {
  --bg-color: #0d1117;
  --text-color: #c9d1d9;
  --accent-color: #00ffe7;
  --input-bg: #161b22;
  --input-border: #30363d;
  --error: #ff4d4d;
  --success: #4CAF50;
  --neon-glow: rgba(0, 255, 231, 0.6);
  --button-hover: #00c2ab;
  --box-shadow: rgba(0, 255, 231, 0.5);
  --max-width: 420px;
  --border-radius: 8px;
  --transition-speed: 0.3s;
  --strength-weak: #ff4d4d;
  --strength-fair: #ffb84d;
  --strength-good: #4db8ff;
  --strength-strong: #4CAF50;
}
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 1rem;
}
header {
  text-align: center;
  margin-bottom: 1.5rem;
}
.logo-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 0.5rem;
}
.logo {
  width: 80px;
  height: 80px;
  object-fit: contain;
  display: block;
}
.tagline {
  color: #fff;
  font-size: 1.1rem;
  margin-bottom: 2rem;
  text-shadow: 0 0 10px var(--accent-color);
  font-weight: 500;
  letter-spacing: 0.5px;
  opacity: 0.95;
}
h1 {
  font-size: 2.5rem;
  color: var(--accent-color);
  text-shadow: 0 0 15px var(--accent-color), 0 0 30px var(--neon-glow);
  margin: 0 0 0.2rem 0;
}
.signup-box {
  background-color: var(--input-bg);
  padding: 2.5rem 2rem;
  border-radius: var(--border-radius);
  box-shadow: 0 0 25px var(--box-shadow);
  width: 100%;
  max-width: var(--max-width);
  box-sizing: border-box;
}
h2 {
  text-align: center;
  margin-bottom: 1.5rem;
  color: var(--accent-color);
  text-shadow: 0 0 15px var(--accent-color), 0 0 30px var(--neon-glow);
  font-size: 1.8rem;
  font-weight: 600;
}
.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 1.5rem;
}
.tab-btn {
  flex: 1;
  padding: 0.75rem 1rem;
  background: none;
  border: none;
  color: var(--accent-color);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 2.5px solid transparent;
  transition: border-color 0.2s, color 0.2s;
}
.tab-btn.active {
  border-bottom: 2.5px solid var(--accent-color);
  color: #fff;
}
.form-section {
  display: none;
  animation: fadeIn 0.4s;
}
.form-section.active {
  display: block;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px);}
  to { opacity: 1; transform: translateY(0);}
}
input, select {
  width: 100%;
  padding: 1rem;
  margin-bottom: 1.2rem;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text-color);
  border-radius: var(--border-radius);
  font-size: 1rem;
  transition: border 0.3s ease, box-shadow 0.3s ease-in-out;
  box-sizing: border-box;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 8px var(--accent-color), 0 0 15px var(--neon-glow);
}
.input-group {
  position: relative;
  margin-bottom: 1.2rem;
}
.show-hide {
  position: absolute;
  top: 50%;
  right: 16px;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--accent-color);
  cursor: pointer;
  padding: 0;
  z-index: 2;
  display: flex;
  align-items: center;
  justify-content: center;
}
.show-hide svg {
  pointer-events: none;
}
.error {
  color: var(--error);
  margin-bottom: 1rem;
  text-align: center;
  font-size: 1.05rem;
  font-weight: bold;
  text-shadow: 0 0 10px var(--error);
}
.success {
  color: var(--success);
  margin-bottom: 1rem;
  text-align: center;
  font-size: 1.05rem;
  font-weight: bold;
  text-shadow: 0 0 10px var(--success);
}
button {
  width: 100%;
  padding: 1rem;
  background: var(--accent-color);
  color: var(--bg-color);
  font-weight: bold;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 1.1rem;
  transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease-in-out;
  margin-bottom: 1rem;
}
button:hover:enabled {
  background-color: var(--button-hover);
  box-shadow: 0 0 10px var(--neon-glow), 0 0 20px var(--neon-glow);
}
button:disabled {
  background-color: #555;
  cursor: not-allowed;
  box-shadow: none;
}
.password-guide {
  margin: 0 0 1em 0;
  padding-left: 1.1em;
  list-style: disc;
  font-size: 0.97em;
  color: #aaa;
  background: transparent;
}
.password-guide li {
  margin-bottom: 0.2em;
  transition: color 0.2s, font-weight 0.2s;
  line-height: 1.4em;
}
.password-guide li.met {
  color: var(--success, #4CAF50);
  font-weight: 600;
}
@media (max-width: 480px) {
  .signup-box {
    padding: 2rem 0.7rem;
  }
  h2 {
    font-size: 1.6rem;
  }
  input, select {
    font-size: 0.95rem;
  }
  button {
    font-size: 1rem;
  }
  .phone-input-group {
    flex-direction: column;
    gap: 0;
    align-items: stretch;
  }
  .phone-input-group select, .phone-input-group input {
    margin-bottom: 0.8rem;
    width: 100% !important;
  }
  .phone-input-group button {
    width: 100%;
  }
  .password-guide {
    font-size: 1em;
    padding-left: 1em;
  }
  .password-guide li {
    margin-bottom: 0.3em;
    line-height: 1.5em;
  }
}
.strength-meter {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  margin-bottom: 0.5rem;
  background: #222;
  overflow: hidden;
  position: relative;
}
.strength-bar {
  height: 100%;
  width: 0%;
  background: var(--strength-weak);
  transition: width 0.3s, background 0.3s;
}
.strength-label {
  font-size: 0.95rem;
  font-weight: 500;
  margin-bottom: 1rem;
  color: var(--strength-weak);
  text-align: right;
  min-height: 1.2em;
}
.strength-good { color: var(--strength-good);}
.strength-strong { color: var(--strength-strong);}
.strength-fair { color: var(--strength-fair);}
.strength-weak { color: var(--strength-weak);}
.nav-link {
  text-align: center;
  margin-top: 1.2rem;
  margin-bottom: 0.5rem;
}
.nav-link a {
  color: var(--accent-color);
  text-decoration: underline;
  font-weight: 600;
  font-size: 1.08rem;
}
#otpSection {
  display: none;
}
#recaptcha-container {
  margin-bottom: 1rem;
}
.phone-input-group {
  display: flex;
  align-items: center;
  margin-bottom: 1.2rem;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.phone-input-group select {
  width: 110px !important;
  min-width: 90px;
  background: var(--input-bg);
  color: var(--text-color);
  border: 1px solid var(--input-border);
  border-radius: var(--border-radius);
  font-size: 1rem;
  padding: 1rem;
  margin-bottom: 0 !important;
  margin-right: 0.5rem;
  flex-shrink: 0;
}
.phone-input-group input[type="tel"] {
  flex-grow: 1;
  margin-bottom: 0 !important;
  min-width: 0;
}
.phone-input-group button {
  width: 120px;
  padding: 1rem 0.5rem;
  margin-bottom: 0;
  flex-shrink: 0;
}
</style>
</head>
<body>

<header>
  <div class="logo-wrapper">
    <img src="images/logo.jpg" alt="Yantrakart Logo" class="logo" />
  </div>
  <div class="tagline"><h3>Smart Projects for Smart Students</h3></div>
  <h1>YANTRAKART USERS</h1>
</header>

<div class="signup-box" aria-label="Signup form">
  <h2>Sign Up</h2>
  <div class="tabs">
    <button class="tab-btn active" id="tabEmail">Email</button>
    <button class="tab-btn" id="tabPhone">Phone</button>
  </div>
  <div class="error" id="errorMsg" role="alert" aria-live="assertive"></div>
  <div class="success" id="successMsg" role="status" aria-live="polite"></div>

  <!-- Email Registration Section -->
  <div class="form-section active" id="emailSection">
    <input type="text" id="nameEmail" placeholder="Full Name" autocomplete="name" required />
    <input type="email" id="email" placeholder="Email" autocomplete="email" required />
    <div class="input-group">
      <input type="password" id="passwordEmail" placeholder="Password" autocomplete="new-password" required />
      <button class="show-hide" type="button" tabindex="-1" id="togglePasswordEmail" aria-label="Show password">
        <svg id="eyeOpenPasswordEmail" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg id="eyeClosedPasswordEmail" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-6.06"></path>
          <path d="M1 1l22 22"></path>
          <path d="M9.53 9.53A3 3 0 0 0 12 15a3 3 0 0 0 2.47-5.47"></path>
          <path d="M14.47 14.47A3 3 0 0 1 12 9a3 3 0 0 1-2.47 5.47"></path>
        </svg>
      </button>
    </div>
    <ul id="email-password-guide" class="password-guide">
      <li id="email-pass-len">At least 8 characters</li>
      <li id="email-pass-upper">At least one uppercase letter</li>
      <li id="email-pass-lower">At least one lowercase letter</li>
      <li id="email-pass-num">At least one number</li>
      <li id="email-pass-spec">At least one special character</li>
    </ul>
    <div class="strength-meter"><div class="strength-bar" id="strengthBarEmail"></div></div>
    <div class="strength-label" id="strengthLabelEmail"></div>
    <div class="input-group">
      <input type="password" id="confirmPasswordEmail" placeholder="Confirm Password" autocomplete="new-password" required />
      <button class="show-hide" type="button" tabindex="-1" id="toggleConfirmPasswordEmail" aria-label="Show password">
        <svg id="eyeOpenConfirmPasswordEmail" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg id="eyeClosedConfirmPasswordEmail" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-6.06"></path>
          <path d="M1 1l22 22"></path>
          <path d="M9.53 9.53A3 3 0 0 0 12 15a3 3 0 0 0 2.47-5.47"></path>
          <path d="M14.47 14.47A3 3 0 0 1 12 9a3 3 0 0 1-2.47 5.47"></path>
        </svg>
      </button>
    </div>
    <div id="emailVerificationSection" style="display:none;">
      <p id="emailVerifiedMsg" class="success" style="display:none;">Email verified</p>
      <button id="sendEmailVerificationBtn" type="button">Send Verification Email</button>
    </div>
    <button id="signupEmailBtn" disabled>Sign Up with Email</button>
  </div>

  <!-- Phone Registration Section -->
  <div class="form-section" id="phoneSection">
    <input type="text" id="namePhone" placeholder="Full Name" autocomplete="name" required />
    <div class="phone-input-group">
      <select id="countryCode">
        <option value="+1">🇺🇸 +1</option>
        <option value="+91" selected>🇮🇳 +91</option>
        <option value="+44">🇬🇧 +44</option>
        <option value="+61">🇦🇺 +61</option>
        <option value="+81">🇯🇵 +81</option>
        <option value="+49">🇩🇪 +49</option>
        <option value="+33">🇫🇷 +33</option>
        <option value="+971">🇦🇪 +971</option>
        <option value="+880">🇧🇩 +880</option>
      </select>
      <input type="tel" id="phone" placeholder="Phone Number" pattern="[0-9]{6,15}" autocomplete="tel" required />
      <button id="sendOtpBtn" type="button" aria-label="Send OTP to phone">Send OTP</button>
    </div>
    <div id="recaptcha-container"></div>
    <div id="otpSection" aria-label="OTP verification section">
      <input type="text" id="otp" placeholder="Enter OTP" maxlength="6" inputmode="numeric" autocomplete="one-time-code" />
      <button id="verifyOtpBtn" type="button">Verify OTP</button>
    </div>
    <div class="input-group">
      <input type="password" id="passwordPhone" placeholder="Password" autocomplete="new-password" required />
      <button class="show-hide" type="button" tabindex="-1" id="togglePasswordPhone" aria-label="Show password">
        <svg id="eyeOpenPasswordPhone" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg id="eyeClosedPasswordPhone" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-6.06"></path>
          <path d="M1 1l22 22"></path>
          <path d="M9.53 9.53A3 3 0 0 0 12 15a3 3 0 0 0 2.47-5.47"></path>
          <path d="M14.47 14.47A3 3 0 0 1 12 9a3 3 0 0 1-2.47 5.47"></path>
        </svg>
      </button>
    </div>
    <ul id="phone-password-guide" class="password-guide">
      <li id="phone-pass-len">At least 8 characters</li>
      <li id="phone-pass-upper">At least one uppercase letter</li>
      <li id="phone-pass-lower">At least one lowercase letter</li>
      <li id="phone-pass-num">At least one number</li>
      <li id="phone-pass-spec">At least one special character</li>
    </ul>
    <div class="strength-meter"><div class="strength-bar" id="strengthBarPhone"></div></div>
    <div class="strength-label" id="strengthLabelPhone"></div>
    <div class="input-group">
      <input type="password" id="confirmPasswordPhone" placeholder="Confirm Password" autocomplete="new-password" required />
      <button class="show-hide" type="button" tabindex="-1" id="toggleConfirmPasswordPhone" aria-label="Show password">
        <svg id="eyeOpenConfirmPasswordPhone" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg id="eyeClosedConfirmPasswordPhone" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-6.06"></path>
          <path d="M1 1l22 22"></path>
          <path d="M9.53 9.53A3 3 0 0 0 12 15a3 3 0 0 0 2.47-5.47"></path>
          <path d="M14.47 14.47A3 3 0 0 1 12 9a3 3 0 0 1-2.47 5.47"></path>
        </svg>
      </button>
    </div>
    <button id="signupPhoneBtn" disabled>Sign Up with Phone</button>
  </div>
  <div class="nav-link">
    <a href="login.html">Already have an account? Log in</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  sendEmailVerification,
  RecaptchaVerifier,
  signInWithPhoneNumber,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, doc, setDoc, addDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyCyjqvnrgCHt3SR4_kD3glRt55ImeXOxxA",
  authDomain: "yantrakartcu.firebaseapp.com",
  projectId: "yantrakartcu",
  storageBucket: "yantrakartcu.firebasestorage.app",
  messagingSenderId: "958180945232",
  appId: "1:958180945232:web:18e049c7682da22b239055",
  measurementId: "G-87FE485DTH"
};
   

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Tabs logic
const tabEmail = document.getElementById("tabEmail");
const tabPhone = document.getElementById("tabPhone");
const emailSection = document.getElementById("emailSection");
const phoneSection = document.getElementById("phoneSection");
tabEmail.addEventListener("click", () => {
  tabEmail.classList.add("active");
  tabPhone.classList.remove("active");
  emailSection.classList.add("active");
  phoneSection.classList.remove("active");
  clearMessages();
});
tabPhone.addEventListener("click", () => {
  tabPhone.classList.add("active");
  tabEmail.classList.remove("active");
  phoneSection.classList.add("active");
  emailSection.classList.remove("active");
  clearMessages();
});

// DOM Elements
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");


function generateReferralCode(length = 8) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < length; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
  return code;
}

// Email section elements
const nameEmail = document.getElementById("nameEmail");
const emailInput = document.getElementById("email");
const passwordEmail = document.getElementById("passwordEmail");
const confirmPasswordEmail = document.getElementById("confirmPasswordEmail");
const signupEmailBtn = document.getElementById("signupEmailBtn");
const emailVerificationSection = document.getElementById("emailVerificationSection");
const sendEmailVerificationBtn = document.getElementById("sendEmailVerificationBtn");
const emailVerifiedMsg = document.getElementById("emailVerifiedMsg");
const strengthBarEmail = document.getElementById("strengthBarEmail");
const strengthLabelEmail = document.getElementById("strengthLabelEmail");

// Phone section elements
const namePhone = document.getElementById("namePhone");
const countryCodeInput = document.getElementById("countryCode");
const phoneInput = document.getElementById("phone");
const sendOtpBtn = document.getElementById("sendOtpBtn");
const otpSection = document.getElementById("otpSection");
const otpInput = document.getElementById("otp");
const verifyOtpBtn = document.getElementById("verifyOtpBtn");
const passwordPhone = document.getElementById("passwordPhone");
const confirmPasswordPhone = document.getElementById("confirmPasswordPhone");
const signupPhoneBtn = document.getElementById("signupPhoneBtn");
const strengthBarPhone = document.getElementById("strengthBarPhone");
const strengthLabelPhone = document.getElementById("strengthLabelPhone");

// Show/hide password toggles
function setupShowHide(passwordField, toggleBtn, eyeOpenId, eyeClosedId) {
  const eyeOpen = document.getElementById(eyeOpenId);
  const eyeClosed = document.getElementById(eyeClosedId);
  toggleBtn.addEventListener("click", () => {
    if (passwordField.type === "password") {
      passwordField.type = "text";
      eyeOpen.style.display = "none";
      eyeClosed.style.display = "inline";
      toggleBtn.setAttribute("aria-label", "Hide password");
    } else {
      passwordField.type = "password";
      eyeOpen.style.display = "inline";
      eyeClosed.style.display = "none";
      toggleBtn.setAttribute("aria-label", "Show password");
    }
  });
}
setupShowHide(passwordEmail, document.getElementById("togglePasswordEmail"), "eyeOpenPasswordEmail", "eyeClosedPasswordEmail");
setupShowHide(confirmPasswordEmail, document.getElementById("toggleConfirmPasswordEmail"), "eyeOpenConfirmPasswordEmail", "eyeClosedConfirmPasswordEmail");
setupShowHide(passwordPhone, document.getElementById("togglePasswordPhone"), "eyeOpenPasswordPhone", "eyeClosedPasswordPhone");
setupShowHide(confirmPasswordPhone, document.getElementById("toggleConfirmPasswordPhone"), "eyeOpenConfirmPasswordPhone", "eyeClosedConfirmPasswordPhone");

// Password guide for both email and phone
function updatePasswordGuide(prefix, password) {
  document.getElementById(prefix+'-pass-len').classList.toggle('met', password.length >= 8);
  document.getElementById(prefix+'-pass-upper').classList.toggle('met', /[A-Z]/.test(password));
  document.getElementById(prefix+'-pass-lower').classList.toggle('met', /[a-z]/.test(password));
  document.getElementById(prefix+'-pass-num').classList.toggle('met', /\d/.test(password));
  document.getElementById(prefix+'-pass-spec').classList.toggle('met', /[^A-Za-z0-9]/.test(password));
}
passwordEmail.addEventListener('input', function() {
  updatePasswordGuide('email', this.value);
});
passwordPhone.addEventListener('input', function() {
  updatePasswordGuide('phone', this.value);
});

// Password strength meter
function getPasswordStrength(password) {
  let score = 0;
  if (password.length >= 8) score++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
  if (/\d/.test(password)) score++;
  if (/[^A-Za-z0-9]/.test(password)) score++;
  if (password.length >= 12) score++;
  return score;
}
function updateStrengthMeter(password, bar, label) {
  const score = getPasswordStrength(password);
  let width = "0%";
  let color = "var(--strength-weak)";
  let text = "";
  let labelClass = "strength-weak";
  if (score === 0) {
    width = "0%";
    text = "";
  } else if (score === 1) {
    width = "25%";
    color = "var(--strength-weak)";
    text = "Weak";
    labelClass = "strength-weak";
  } else if (score === 2) {
    width = "50%";
    color = "var(--strength-fair)";
    text = "Fair";
    labelClass = "strength-fair";
  } else if (score === 3 || score === 4) {
    width = "75%";
    color = "var(--strength-good)";
    text = "Good";
    labelClass = "strength-good";
  } else if (score === 5) {
    width = "100%";
    color = "var(--strength-strong)";
    text = "Strong";
    labelClass = "strength-strong";
  }
  bar.style.width = width;
  bar.style.background = color;
  label.textContent = text;
  label.className = "strength-label " + labelClass;
}
passwordEmail.addEventListener('input', () => {
  updateStrengthMeter(passwordEmail.value, strengthBarEmail, strengthLabelEmail);
  checkSignupEmailEligibility();
});
passwordPhone.addEventListener('input', () => {
  updateStrengthMeter(passwordPhone.value, strengthBarPhone, strengthLabelPhone);
  checkSignupPhoneEligibility();
});

// Error/Success helpers
function setError(message) {
  errorMsg.textContent = message;
  successMsg.textContent = "";
}
function setSuccess(message) {
  successMsg.textContent = message;
  errorMsg.textContent = "";
}
function clearMessages() {
  errorMsg.textContent = "";
  successMsg.textContent = "";
}

// reCAPTCHA Setup (only once)
let recaptchaVerifier = null;
function setupRecaptcha() {
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier(
      auth,
      'recaptcha-container',
      {
        size: 'invisible',
        callback: (response) => {},
        'expired-callback': () => {
          setError("reCAPTCHA expired, please try again.");
        }
      }
    );
    recaptchaVerifier.render();
  }
}
setupRecaptcha();

// --- Email Section Logic ---
function checkSignupEmailEligibility() {
  const name = nameEmail.value.trim();
  const email = emailInput.value.trim();
  const password = passwordEmail.value.trim();
  const confirmPassword = confirmPasswordEmail.value.trim();
  const strength = getPasswordStrength(password);

  if (!name) {
    setError("Please enter your name.");
    signupEmailBtn.disabled = true;
    return;
  }
  if (!email) {
    setError("Please enter your email.");
    signupEmailBtn.disabled = true;
    return;
  }
  if (!password) {
    setError("Please enter your password.");
    signupEmailBtn.disabled = true;
    return;
  }
  if (!confirmPassword) {
    setError("Please confirm your password.");
    signupEmailBtn.disabled = true;
    return;
  }
  if (password !== confirmPassword) {
    setError("Passwords do not match.");
    signupEmailBtn.disabled = true;
    return;
  }
  if (strength < 3) {
    setError("Password must be Good or Strong. Use a mix of uppercase, lowercase, numbers, and symbols.");
    signupEmailBtn.disabled = true;
    return;
  }
  setError("");
  signupEmailBtn.disabled = false;
}
nameEmail.addEventListener('input', checkSignupEmailEligibility);
emailInput.addEventListener('input', checkSignupEmailEligibility);
confirmPasswordEmail.addEventListener('input', checkSignupEmailEligibility);

signupEmailBtn.addEventListener("click", async () => {
  clearMessages();
  const name = nameEmail.value.trim();
  const email = emailInput.value.trim();
  const password = passwordEmail.value.trim();
  const confirmPassword = confirmPasswordEmail.value.trim();

  if (!name || !email || !password || !confirmPassword || password !== confirmPassword || getPasswordStrength(password) < 3) {
    checkSignupEmailEligibility();
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
   await setDoc(doc(db, "users", userCredential.user.uid), {
  name,
  email,
  phone: "",
  referralCode: generateReferralCode(), // <-- Add this line
  createdAt: new Date()
});
await addDoc(collection(db, "notifications"), {
  userEmail: email,
  message: `New user signed up: ${name}`,
  type: "signup",
  createdAt: serverTimestamp()
});

if (referralCodeUsed) {
  await addDoc(collection(db, "notifications"), {
    userEmail: email || (countryCode + phone),
    message: `Referral code used: ${referralCodeUsed}`,
    type: "referral",
    createdAt: serverTimestamp()
  });
}

    emailVerificationSection.style.display = "block";
    await sendEmailVerification(userCredential.user);
    setSuccess("Signup successful! Please verify your email.");
    setTimeout(() => { window.location.href = "login.html"; }, 5000);
  } catch (e) {
    let msg = "Failed to sign up with email.";
    if (e.code === "auth/email-already-in-use") {
      msg = "This email is already registered. Please log in or use another email.";
    } else if (e.code === "auth/invalid-email") {
      msg = "Invalid email address. Please check and try again.";
    } else if (e.code === "auth/weak-password") {
      msg = "Password is too weak. Please use a stronger password.";
    } else if (e.message) {
      msg = e.message;
    }
    setError(msg);
  }
});

// Email Verification Section
sendEmailVerificationBtn.addEventListener("click", async () => {
  clearMessages();
  const user = auth.currentUser;
  if (!user) return setError("You must sign up first before verifying email.");
  try {
    await sendEmailVerification(user);
    setSuccess("Verification email sent. Please check your inbox.");
  } catch (error) {
    setError("Failed to send verification email: " + error.message);
  }
});

onAuthStateChanged(auth, user => {
  if (user && user.emailVerified) {
    emailVerifiedMsg.style.display = 'block';
    sendEmailVerificationBtn.style.display = 'none';
  } else {
    emailVerifiedMsg.style.display = 'none';
    sendEmailVerificationBtn.style.display = 'inline-block';
  }
});

// --- Phone Section Logic ---
let confirmationResult = null;
let phoneVerified = false;

function checkSignupPhoneEligibility() {
  const name = namePhone.value.trim();
  const phone = phoneInput.value.trim();
  const password = passwordPhone.value.trim();
  const confirmPassword = confirmPasswordPhone.value.trim();
  const strength = getPasswordStrength(password);

  if (!name) {
    setError("Please enter your name.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (!phone) {
    setError("Please enter your phone number.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (!phoneVerified) {
    setError("Please verify your phone number via OTP first.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (!password) {
    setError("Please enter your password.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (!confirmPassword) {
    setError("Please confirm your password.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (password !== confirmPassword) {
    setError("Passwords do not match.");
    signupPhoneBtn.disabled = true;
    return;
  }
  if (strength < 3) {
    setError("Password must be Good or Strong. Use a mix of uppercase, lowercase, numbers, and symbols.");
    signupPhoneBtn.disabled = true;
    return;
  }
  setError("");
  signupPhoneBtn.disabled = false;
}
namePhone.addEventListener('input', checkSignupPhoneEligibility);
phoneInput.addEventListener('input', () => {
  phoneVerified = false;
  otpSection.style.display = 'none';
  signupPhoneBtn.disabled = true;
  clearMessages();
  checkSignupPhoneEligibility();
});
confirmPasswordPhone.addEventListener('input', checkSignupPhoneEligibility);

sendOtpBtn.addEventListener("click", async () => {
  clearMessages();
  phoneVerified = false;
  signupPhoneBtn.disabled = true;
  otpSection.style.display = 'none';

  const countryCode = countryCodeInput.value;
  const phone = phoneInput.value.trim();
  if (!phone) return setError("Please enter your phone number.");
  if (!/^\d{6,15}$/.test(phone)) return setError("Please enter a valid phone number.");
  const fullPhone = countryCode + phone;
  try {
    confirmationResult = await signInWithPhoneNumber(auth, fullPhone, recaptchaVerifier);
    otpSection.style.display = 'block';
    setSuccess("OTP sent to your phone. Enter the code below.");
  } catch (error) {
    let msg = "Failed to send OTP.";
    if (error.code === "auth/too-many-requests") {
      msg = "Too many OTP requests. Please wait and try again later.";
    } else if (error.message) {
      msg = error.message;
    }
    setError(msg);
  }
});

verifyOtpBtn.addEventListener("click", async () => {
  clearMessages();
  const otp = otpInput.value.trim();
  if (!otp) return setError("Please enter the OTP.");
  try {
    const result = await confirmationResult.confirm(otp);
    phoneVerified = true;
    signupPhoneBtn.disabled = false;
    otpSection.style.display = 'none';
    setSuccess("Phone verified successfully!");
    phoneInput.value = result.user.phoneNumber.replace(countryCodeInput.value, '');
    checkSignupPhoneEligibility();
  } catch (error) {
    setError("Invalid OTP. Try again.");
    checkSignupPhoneEligibility();
  }
});

signupPhoneBtn.addEventListener("click", async () => {
  clearMessages();
  const name = namePhone.value.trim();
  const countryCode = countryCodeInput.value;
  const phone = phoneInput.value.trim();
  const password = passwordPhone.value.trim();
  const confirmPassword = confirmPasswordPhone.value.trim();

  if (!name || !phone || !phoneVerified || !password || !confirmPassword || password !== confirmPassword || getPasswordStrength(password) < 3) {
    checkSignupPhoneEligibility();
    return;
  }

  try {
    const dummyEmail = countryCode.replace('+','') + phone + "@phoneuser.yantrakart";
    const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
    await setDoc(doc(db, "users", userCredential.user.uid), {
  name,
  email: "",
  phone: countryCode + phone,
  referralCode: generateReferralCode(), // <-- Add this line
  createdAt: new Date()
});
await addDoc(collection(db, "notifications"), {
  userPhone: countryCode + phone,
  message: `New user signed up: ${name}`,
  type: "signup",
  createdAt: serverTimestamp()
});

    setSuccess("Signup with phone successful! Redirecting to login…");
    setTimeout(() => { window.location.href = "login.html"; }, 3000);
  } catch (e) {
    let msg = "Failed to sign up with phone.";
    if (e.code === "auth/email-already-in-use") {
      msg = "This phone is already registered. Please log in or use another phone.";
    } else if (e.code === "auth/invalid-email") {
      msg = "Invalid phone/email. Please check and try again.";
    } else if (e.code === "auth/weak-password") {
      msg = "Password is too weak. Please use a stronger password.";
    } else if (e.message) {
      msg = e.message;
    }
    setError(msg);
  }
});
</script>
</body>
</html>
